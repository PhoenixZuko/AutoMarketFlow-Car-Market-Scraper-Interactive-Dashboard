$(document).ready(function () {
    // Clonează headerul pentru filtre
    $('#carTable thead tr')
        .clone(true)
        .addClass('filters')
        .appendTo('#carTable thead');

    // Inițializare tabel
    var table = $('#carTable').DataTable({
        orderCellsTop: true,
        fixedHeader: true,
        paging: true,
        searching: true,
        ordering: true,
        autoWidth: false,
        responsive: true,
        order: [[18, 'desc']],
        columnDefs: [
            { type: "num", targets: [0, 2, 6, 7, 11, 12, 16, 18, 20, 21, 22] },
            { type: "string", targets: [1, 3, 4, 5, 8, 9, 10, 14, 15, 17, 19, 23] }
        ],
        initComplete: function () {
            var api = this.api();
            api.columns().eq(0).each(function (colIdx) {
                var cell = $('.filters th').eq($(api.column(colIdx).header()).index());
                var title = $(cell).text();
                $(cell).html('<input type="text" placeholder="Search ' + title + '" style="width: 100%"/>');
                $('input', cell).on('keyup change', function () {
                    api.column(colIdx).search(this.value).draw();
                });
            });
        },
        headerCallback: function (thead) {
            $(thead).find('tr.filters').css('pointer-events', 'none');
        }
    });

    // Funcție de verificare range numeric
    function inRange(val, min, max) {
        min = parseFloat(min);
        max = parseFloat(max);
        return val >= (isNaN(min) ? -Infinity : min) && val <= (isNaN(max) ? Infinity : max);
    }

    // Filtrare extinsă pe coloane
    $.fn.dataTable.ext.search.push(function (settings, data, dataIndex) {
        let price     = parseFloat(data[2].replace(/[^0-9.-]/g, '')) || 0;
        let year      = parseInt(data[6]) || 0;
        let miles     = parseFloat(data[7].replace(/,/g, '')) || 0;
        let owner     = parseInt(data[12]) || 0;
        let fbrat     = parseFloat(data[16]) || 0;
        let joinedFB  = parseInt(data[19]) || 0;
        let listed    = parseFloat(data[20].replace(/[^0-9.-]/g, '')) || 0;
        let carScore  = parseFloat(data[21]) || 0;
        let sellerNo  = parseFloat(data[22]) || 0;

        if (!inRange(price,     $('#filter-price-min').val(),    $('#filter-price-max').val())) return false;
        if (!inRange(year,      $('#filter-year-min').val(),     $('#filter-year-max').val())) return false;
        if (!inRange(miles,     $('#filter-miles-min').val(),    $('#filter-miles-max').val())) return false;
        if (!inRange(owner,     $('#filter-owner-min').val(),    $('#filter-owner-max').val())) return false;
        if (!inRange(fbrat,     $('#filter-fbrat-min').val(),    $('#filter-fbrat-max').val())) return false;
        if (!inRange(joinedFB,  $('#filter-joinedfb-min').val(), $('#filter-joinedfb-max').val())) return false;
        if (!inRange(listed,    $('#filter-listed-min').val(),   $('#filter-listed-max').val())) return false;
        if (!inRange(sellerNo,  $('#filter-seller-min').val(),   $('#filter-seller-max').val())) return false;
        if (!inRange(carScore,  $('#filter-car-min').val(),      $('#filter-car-max').val())) return false;

        return true;
    });

    // Aplicare filtre custom
    $('#custom-filters input').on('keyup change', function () {
        table.draw();
    });

    // Butoane cu keyword-uri
    $('.keyword-btn').on('click', function () {
        let keyword = $(this).data('keyword');
        table.search(keyword).draw();
    });
});

// Modal
function showModal(text) {
    document.getElementById('modal-text').innerHTML = text;
    document.getElementById('popup-modal').style.display = 'block';
}

function closeModal() {
    document.getElementById('popup-modal').style.display = 'none';
}
